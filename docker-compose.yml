version: '3.8'

services:
  # Jenkins Master
  jenkins:
    image: jenkins/jenkins:lts-jdk11
    container_name: jenkins
    user: root
    environment:
      - MAVEN_HOME=/usr/share/maven
      - PATH=$PATH:/usr/share/maven/bin
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DOCKER_TLS_CERTDIR=""
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false -Duser.timezone=America/Los_Angeles
    volumes:
      - jenkins_home:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /usr/local/bin/docker:/usr/bin/docker
      - ./jenkins_home:/var/jenkins_home
      - ./scripts:/var/jenkins_scripts
      - maven-repo:/root/.m2
    ports:
      - "9090:8080"
      - "50001:50000"
    command: |
      bash -c "apt-get update && \
               apt-get install -y maven && \
               /usr/local/bin/jenkins.sh"
    privileged: true
    networks:
      - ci-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - docker-dind

  # Docker-in-Docker service
  docker-dind:
    image: docker:dind
    container_name: docker-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=""
    volumes:
      - docker-graph:/var/lib/docker
    networks:
      - ci-network

  # Kubernetes CLI
  kubectl:
    image: rancher/k3d:latest
    container_name: kubectl
    volumes:
      - ./kube:/root/.kube
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]
    networks:
      - ci-network

  # Visualize containers (optional)
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    ports:
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - ci-network

networks:
  ci-network:
    driver: bridge

volumes:
  jenkins_home:
  docker-graph:
  maven-repo:
  portainer_data:
